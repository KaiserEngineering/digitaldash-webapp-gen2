name: ESP-IDF Build and Release

on:
  push:
    tags:
      - 'v*' # Trigger on tags starting with "v"

permissions:
  contents: write

jobs:
  build-and-release:
    runs-on: ubuntu-latest

    steps:
      # Checkout the code
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          submodules: recursive

      # Setup Node.js
      - name: Setup Node.js
        uses: actions/setup-node@v3
        with:
          node-version: 24 # Specify the Node.js version
          check-latest: true   # Ensures the latest patch of the specified version is used

      # Install dependencies and build frontend
      - name: Install and Build Frontend
        working-directory: front
        run: |
          npm install
          npm run build
  
      # Build with ESP-IDF
      - name: Build with ESP-IDF
        uses: espressif/esp-idf-ci-action@v1
        with:
          esp_idf_version: v5.2.3 # Specify the ESP-IDF version
          target: esp32s3         # Specify the ESP-IDF target
          path: './'              # Set the project path (default is the current directory)

      # Create a release and upload artifacts
      - name: Create GitHub Release
        uses: softprops/action-gh-release@v1
        with:
          files: build/KE_DigitalDash_Webapp.bin
          body_path: CHANGELOG.md
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
